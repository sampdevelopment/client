#include <windows.h>
#include <string.h>
#include "../main.h"

DWORD dwTotalSystemMemoryInMB = 0;
DWORD dwStreamingMemory = 0;

void InstallSCMEventsProcessor();
void RelocateScanListHack();
void RelocatePedsListHack();

typedef struct {
	unsigned char r, g, b, a;
} RwRGBA;

static float fPickupDistance = 10000.0f;

const RwRGBA g_pVehicleColor[] = {
	{0x00,0x00,0x00,0xFF},{0xF5,0xF5,0xF5,0xFF},{0x2A,0x77,0xA1,0xFF},{0x84,0x04,0x10,0xFF},
	{0x26,0x37,0x39,0xFF},{0x86,0x44,0x6E,0xFF},{0xD7,0x8E,0x10,0xFF},{0x4C,0x75,0xB7,0xFF},
	{0xBD,0xBE,0xC6,0xFF},{0x5E,0x70,0x72,0xFF},{0x46,0x59,0x7A,0xFF},{0x65,0x6A,0x79,0xFF},
	{0x5D,0x7E,0x8D,0xFF},{0x58,0x59,0x5A,0xFF},{0xD6,0xDA,0xD6,0xFF},{0x9C,0xA1,0xA3,0xFF},
	{0x33,0x5F,0x3F,0xFF},{0x73,0x0E,0x1A,0xFF},{0x7B,0x0A,0x2A,0xFF},{0x9F,0x9D,0x94,0xFF},
	{0x3B,0x4E,0x78,0xFF},{0x73,0x2E,0x3E,0xFF},{0x69,0x1E,0x3B,0xFF},{0x96,0x91,0x8C,0xFF},
	{0x51,0x54,0x59,0xFF},{0x3F,0x3E,0x45,0xFF},{0xA5,0xA9,0xA7,0xFF},{0x63,0x5C,0x5A,0xFF},
	{0x3D,0x4A,0x68,0xFF},{0x97,0x95,0x92,0xFF},{0x42,0x1F,0x21,0xFF},{0x5F,0x27,0x2B,0xFF},
	{0x84,0x94,0xAB,0xFF},{0x76,0x7B,0x7C,0xFF},{0x64,0x64,0x64,0xFF},{0x5A,0x57,0x52,0xFF},
	{0x25,0x25,0x27,0xFF},{0x2D,0x3A,0x35,0xFF},{0x93,0xA3,0x96,0xFF},{0x6D,0x7A,0x88,0xFF},
	{0x22,0x19,0x18,0xFF},{0x6F,0x67,0x5F,0xFF},{0x7C,0x1C,0x2A,0xFF},{0x5F,0x0A,0x15,0xFF},
	{0x19,0x38,0x26,0xFF},{0x5D,0x1B,0x20,0xFF},{0x9D,0x98,0x72,0xFF},{0x7A,0x75,0x60,0xFF},
	{0x98,0x95,0x86,0xFF},{0xAD,0xB0,0xB0,0xFF},{0x84,0x89,0x88,0xFF},{0x30,0x4F,0x45,0xFF},
	{0x4D,0x62,0x68,0xFF},{0x16,0x22,0x48,0xFF},{0x27,0x2F,0x4B,0xFF},{0x7D,0x62,0x56,0xFF},
	{0x9E,0xA4,0xAB,0xFF},{0x9C,0x8D,0x71,0xFF},{0x6D,0x18,0x22,0xFF},{0x4E,0x68,0x81,0xFF},
	{0x9C,0x9C,0x98,0xFF},{0x91,0x73,0x47,0xFF},{0x66,0x1C,0x26,0xFF},{0x94,0x9D,0x9F,0xFF},
	{0xA4,0xA7,0xA5,0xFF},{0x8E,0x8C,0x46,0xFF},{0x34,0x1A,0x1E,0xFF},{0x6A,0x7A,0x8C,0xFF},
	{0xAA,0xAD,0x8E,0xFF},{0xAB,0x98,0x8F,0xFF},{0x85,0x1F,0x2E,0xFF},{0x6F,0x82,0x97,0xFF},
	{0x58,0x58,0x53,0xFF},{0x9A,0xA7,0x90,0xFF},{0x60,0x1A,0x23,0xFF},{0x20,0x20,0x2C,0xFF},
	{0xA4,0xA0,0x96,0xFF},{0xAA,0x9D,0x84,0xFF},{0x78,0x22,0x2B,0xFF},{0x0E,0x31,0x6D,0xFF},
	{0x72,0x2A,0x3F,0xFF},{0x7B,0x71,0x5E,0xFF},{0x74,0x1D,0x28,0xFF},{0x1E,0x2E,0x32,0xFF},
	{0x4D,0x32,0x2F,0xFF},{0x7C,0x1B,0x44,0xFF},{0x2E,0x5B,0x20,0xFF},{0x39,0x5A,0x83,0xFF},
	{0x6D,0x28,0x37,0xFF},{0xA7,0xA2,0x8F,0xFF},{0xAF,0xB1,0xB1,0xFF},{0x36,0x41,0x55,0xFF},
	{0x6D,0x6C,0x6E,0xFF},{0x0F,0x6A,0x89,0xFF},{0x20,0x4B,0x6B,0xFF},{0x2B,0x3E,0x57,0xFF},
	{0x9B,0x9F,0x9D,0xFF},{0x6C,0x84,0x95,0xFF},{0x4D,0x84,0x95,0xFF},{0xAE,0x9B,0x7F,0xFF},
	{0x40,0x6C,0x8F,0xFF},{0x1F,0x25,0x3B,0xFF},{0xAB,0x92,0x76,0xFF},{0x13,0x45,0x73,0xFF},
	{0x96,0x81,0x6C,0xFF},{0x64,0x68,0x6A,0xFF},{0x10,0x50,0x82,0xFF},{0xA1,0x99,0x83,0xFF},
	{0x38,0x56,0x94,0xFF},{0x52,0x56,0x61,0xFF},{0x7F,0x69,0x56,0xFF},{0x8C,0x92,0x9A,0xFF},
	{0x59,0x6E,0x87,0xFF},{0x47,0x35,0x32,0xFF},{0x44,0x62,0x4F,0xFF},{0x73,0x0A,0x27,0xFF},
	{0x22,0x34,0x57,0xFF},{0x64,0x0D,0x1B,0xFF},{0xA3,0xAD,0xC6,0xFF},{0x69,0x58,0x53,0xFF},
	{0x9B,0x8B,0x80,0xFF},{0x62,0x0B,0x1C,0xFF},{0x5B,0x5D,0x5E,0xFF},{0x62,0x44,0x28,0xFF},
	{0x73,0x18,0x27,0xFF},{0x1B,0x37,0x6D,0xFF},{0xEC,0x6A,0xAE,0xFF},{0x00,0x00,0x00,0xFF},
	{0x17,0x75,0x17,0xFF},{0x21,0x06,0x06,0xFF},{0x12,0x54,0x78,0xFF},{0x45,0x2A,0x0D,0xFF},
	{0x57,0x1E,0x1E,0xFF},{0x01,0x07,0x01,0xFF},{0x25,0x22,0x5A,0xFF},{0x2C,0x89,0xAA,0xFF},
	{0x8A,0x4D,0xBD,0xFF},{0x35,0x96,0x3A,0xFF},{0xB7,0xB7,0xB7,0xFF},{0x46,0x4C,0x8D,0xFF},
	{0x84,0x88,0x8C,0xFF},{0x81,0x78,0x67,0xFF},{0x81,0x7A,0x26,0xFF},{0x6A,0x50,0x6F,0xFF},
	{0x58,0x3E,0x6F,0xFF},{0x8C,0xB9,0x72,0xFF},{0x82,0x4F,0x78,0xFF},{0x6D,0x27,0x6A,0xFF},
	{0x1E,0x1D,0x13,0xFF},{0x1E,0x13,0x06,0xFF},{0x1F,0x25,0x18,0xFF},{0x2C,0x45,0x31,0xFF},
	{0x1E,0x4C,0x99,0xFF},{0x2E,0x5F,0x43,0xFF},{0x1E,0x99,0x48,0xFF},{0x1E,0x99,0x99,0xFF},
	{0x99,0x99,0x76,0xFF},{0x7C,0x84,0x99,0xFF},{0x99,0x2E,0x1E,0xFF},{0x2C,0x1E,0x08,0xFF},
	{0x14,0x24,0x07,0xFF},{0x99,0x3E,0x4D,0xFF},{0x1E,0x4C,0x99,0xFF},{0x19,0x81,0x81,0xFF},
	{0x1A,0x29,0x2A,0xFF},{0x16,0x61,0x6F,0xFF},{0x1B,0x66,0x87,0xFF},{0x6C,0x3F,0x99,0xFF},
	{0x48,0x1A,0x0E,0xFF},{0x7A,0x73,0x99,0xFF},{0x74,0x6D,0x99,0xFF},{0x53,0x38,0x7E,0xFF},
	{0x22,0x24,0x07,0xFF},{0x3E,0x19,0x0C,0xFF},{0x46,0x21,0x0E,0xFF},{0x99,0x1E,0x1E,0xFF},
	{0x8D,0x4C,0x8D,0xFF},{0x80,0x5B,0x80,0xFF},{0x7B,0x3E,0x7E,0xFF},{0x3C,0x17,0x37,0xFF},
	{0x73,0x35,0x17,0xFF},{0x78,0x18,0x18,0xFF},{0x83,0x34,0x1A,0xFF},{0x8E,0x2F,0x1C,0xFF},
	{0x7E,0x3E,0x53,0xFF},{0x7C,0x6D,0x7C,0xFF},{0x02,0x0C,0x02,0xFF},{0x07,0x24,0x07,0xFF},
	{0x16,0x30,0x12,0xFF},{0x16,0x30,0x1B,0xFF},{0x64,0x2B,0x4F,0xFF},{0x36,0x84,0x52,0xFF},
	{0x99,0x95,0x90,0xFF},{0x81,0x8D,0x96,0xFF},{0x99,0x99,0x1E,0xFF},{0x7F,0x99,0x4C,0xFF},
	{0x83,0x92,0x92,0xFF},{0x78,0x82,0x22,0xFF},{0x2B,0x3C,0x99,0xFF},{0x3A,0x3A,0x0B,0xFF},
	{0x8A,0x79,0x4E,0xFF},{0x0E,0x1F,0x49,0xFF},{0x15,0x37,0x1C,0xFF},{0x15,0x27,0x3A,0xFF},
	{0x37,0x57,0x75,0xFF},{0x06,0x08,0x20,0xFF},{0x07,0x13,0x26,0xFF},{0x20,0x39,0x4B,0xFF},
	{0x2C,0x50,0x89,0xFF},{0x15,0x42,0x6C,0xFF},{0x10,0x32,0x50,0xFF},{0x24,0x16,0x63,0xFF},
	{0x69,0x20,0x15,0xFF},{0x8C,0x8D,0x94,0xFF},{0x51,0x60,0x13,0xFF},{0x09,0x0F,0x02,0xFF},
	{0x8C,0x57,0x3A,0xFF},{0x52,0x88,0x8E,0xFF},{0x99,0x5C,0x52,0xFF},{0x99,0x58,0x1E,0xFF},
	{0x99,0x3A,0x63,0xFF},{0x99,0x8F,0x4E,0xFF},{0x99,0x31,0x1E,0xFF},{0x0D,0x18,0x42,0xFF},
	{0x52,0x1E,0x1E,0xFF},{0x42,0x42,0x0D,0xFF},{0x4C,0x99,0x1E,0xFF},{0x08,0x2A,0x1D,0xFF},
	{0x96,0x82,0x1D,0xFF},{0x19,0x7F,0x19,0xFF},{0x3B,0x14,0x1F,0xFF},{0x74,0x52,0x17,0xFF},
	{0x89,0x3F,0x8D,0xFF},{0x7E,0x1A,0x6C,0xFF},{0x0B,0x37,0x0B,0xFF},{0x27,0x45,0x0D,0xFF},
	{0x07,0x1F,0x24,0xFF},{0x78,0x45,0x73,0xFF},{0x8A,0x65,0x3A,0xFF},{0x73,0x26,0x17,0xFF},
	{0x31,0x94,0x90,0xFF},{0x56,0x94,0x1D,0xFF},{0x59,0x16,0x3D,0xFF},{0x1B,0x8A,0x2F,0xFF},
	{0x38,0x16,0x0B,0xFF},{0x04,0x18,0x04,0xFF},{0x35,0x5D,0x8E,0xFF},{0x2E,0x3F,0x5B,0xFF},
	{0x56,0x1A,0x28,0xFF},{0x4E,0x0E,0x27,0xFF},{0x70,0x6C,0x67,0xFF},{0x3B,0x3E,0x42,0xFF},
	{0x2E,0x2D,0x33,0xFF},{0x7B,0x7E,0x7D,0xFF},{0x4A,0x44,0x42,0xFF},{0x28,0x34,0x4E,0xFF}
};

void ApplyDebugLevelPatches()
{
	memset((PVOID)0x609A4E, 0x90, 6);
}

void ApplyManualVehicleLightsPatch()
{
	static bool bInited = false;
	if (bInited)
		return;

	memset((void*)0x6E1BE3, 0x90, 37);
	memset((void*)0x6E1C38, 0x90, 8);
	memset((void*)0x6E1D98, 0x90, 15);
	memset((void*)0x6E1DBC, 0x90, 8);
	memset((void*)0x6E1BA0, 0x90, 6);
	memset((void*)0x6E1BB1, 0x90, 6);
	memset((void*)0x6E1BD2, 0x90, 7);

	const BYTE byteVehicleLightRenderPatch[] = { 0x8A,0x86,0x28,0x04,0x00,0x00,0xA8,0x40,0x74,0x28 };
	memcpy((void*)0x6E1BE5, byteVehicleLightRenderPatch, sizeof(byteVehicleLightRenderPatch));

	bInited = true;
}

bool ApplyPreGamePatches()
{
	BYTE* pbyteVersionDetermination = (PBYTE)ADDR_BYPASS_VIDS_USA10;
	int iCounter = 0;

	while ((*pbyteVersionDetermination != 0x89) && (*pbyteVersionDetermination != 0xC8))
	{
		if (*(PBYTE)ADDR_GAME_STARTED == 1)
			return false;

		Sleep(10);
		if (++iCounter > 6000)
			return false;
	}

	if (*pbyteVersionDetermination == 0x89)
		iGtaVersion = GTASA_VERSION_USA10;
	else if (*pbyteVersionDetermination == 0xC8)
		iGtaVersion = GTASA_VERSION_EU10;

	*(BYTE*)ADDR_ENTRY = 5;
	memset((PVOID)((iGtaVersion == GTASA_VERSION_USA10) ? ADDR_BYPASS_VIDS_USA10 : ADDR_BYPASS_VIDS_EU10), 0x90, 6);

	strcpy_s((PCHAR)0x866CD8, 11, "title");
	strcpy_s((PCHAR)0x866CCC, 8, "title");

	MEMORYSTATUSEX state;
	state.dwLength = sizeof(state);
	GlobalMemoryStatusEx(&state);

	dwTotalSystemMemoryInMB = (DWORD)(state.ullTotalPhys >> 20);

	if (dwTotalSystemMemoryInMB > 4000)
		dwStreamingMemory = 0x40000000;
	else if (dwTotalSystemMemoryInMB > 2000)
		dwStreamingMemory = 0x20000000;
	else if (dwTotalSystemMemoryInMB > 1000)
		dwStreamingMemory = 0x10000000;
	else if (dwTotalSystemMemoryInMB > 500)
		dwStreamingMemory = 0x08000000;
	else
		dwStreamingMemory = 0x06000000;

	*(DWORD*)0x5B8E6A = dwStreamingMemory;

	return true;
}

static BYTE pbyteVehiclePoolAllocPatch[] = { 0x6A,0x00,0x68,0xC6,0x02,0x00,0x00 };
static BYTE pbyteCollisionPoolAllocPatch[] = { 0x68,0xFF,0x7E,0x00,0x00 };
static BYTE pbyteEntryInfoPoolAllocPatch[] = { 0x68,0x00,0x08,0x00,0x00 };
static BYTE pbyteTrainDelrailmentPatch[] = { 0xB8, 0x89, 0x8F, 0x6F, 0x00, 0xFF, 0xE0 };

void ApplyInGamePatches()
{
	memcpy((PVOID)0x551024, pbyteVehiclePoolAllocPatch, sizeof(pbyteVehiclePoolAllocPatch));

	*(DWORD*)0x55105F = 20000;
	*(DWORD*)0x5510CF = 4000;
	*(DWORD*)0x550F46 = 100000;
	*(DWORD*)0x550F82 = 8000;
	*(DWORD*)0x550FBA = 5000;
	*(DWORD*)0x551097 = 3000;
	*(DWORD*)0x54F3A1 = 6000;

	*(PBYTE)0x550FF2 = 240;
	*(PBYTE)0x551283 = 240;

	*(PBYTE)0x551140 = 0x05;
	*(PBYTE)0x551178 = 0x01;
	*(PBYTE)0x54F3A2 = 0x15;

	*(BYTE*)0x5B8FDE = 0x6A;
	*(BYTE*)0x5B8FDF = 0x00;
	*(BYTE*)0x5B8FE0 = 0x68;
	*(BYTE*)0x5B8FE1 = 200;
	*(BYTE*)0x5B8FE2 = 0x00;
	*(BYTE*)0x5B8FE3 = 0x00;
	*(BYTE*)0x5B8FE4 = 0x00;

	memcpy((PVOID)0x551106, pbyteCollisionPoolAllocPatch, sizeof(pbyteCollisionPoolAllocPatch));
	memcpy((PVOID)0x550FB9, pbyteEntryInfoPoolAllocPatch, sizeof(pbyteEntryInfoPoolAllocPatch));

	memset((PVOID)0x4DF7E2, 0x90, 2);
	memset((PVOID)0x53C159, 0x90, 5);
	memset((PVOID)0x53C136, 0x90, 5);

	memset((PVOID)0x58FBE9, 0x90, 5);
	memset((PVOID)0x5720A5, 0x90, 5);

	*(BYTE*)0x86D1EC = '\0';

	memset((PVOID)0x53C090, 0x90, 5);
	memset((PVOID)0x440833, 0x90, 8);
	memset((PVOID)0x53EA08, 0x90, 10);
	memset((PVOID)0x609C08, 0x90, 39);
	memset((PVOID)0x56E0FA, 0x90, 18);
	memset((PVOID)0x6BC9EB, 0x90, 2);

	memset((PVOID)0x5B47B0, 0xC3, 1);
	memset((PVOID)0x593D7C, 0x90, 5);

	*(DWORD*)0x454CC9 = (DWORD)&fPickupDistance;

	memset((PVOID)0x5952A6, 0x90, 5);

	memset((PVOID)0x5E63A6, 0x90, 19);
	memset((PVOID)0x621AEA, 0x90, 12);
	memset((PVOID)0x62D331, 0x90, 11);
	memset((PVOID)0x741FFF, 0x90, 27);

	*(BYTE*)0x4090A0 = 0xC3;
	memset((void*)0x441482, 0x90, 5);

	if (iGtaVersion == GTASA_VERSION_USA10)
	{
		*(BYTE*)0x7469AF = 0x33;
		*(BYTE*)0x7469B0 = 0xC0;
	}
	else
	{
		*(BYTE*)0x7469FF = 0x33;
		*(BYTE*)0x746A00 = 0xC0;
	}

	*(BYTE*)0x588BE0 = 0xC3;

	memset((PVOID)0x53C06A, 0x90, 5);
	memset((PVOID)0x434272, 0x90, 5);

	*(PBYTE)0x60D64E = 0x84;

	memset((PVOID)0x542485, 0x90, 11);

	*(BYTE*)0x612710 = 0x33;
	*(BYTE*)0x612711 = 0xC0;
	*(BYTE*)0x612712 = 0xC3;

	memset((PVOID)0x613BA7, 0x90, 5);

	memset((PVOID)0x609A4E, 0x90, 6);

	memset((PVOID)0x006F8CF8, 0x90, 5);
	memcpy((PVOID)(0x006F8CF8 + 5), pbyteTrainDelrailmentPatch, sizeof(pbyteTrainDelrailmentPatch));

	memset((PVOID)0x53C1C1, 0x90, 5);

	memset((PVOID)0x540040, 0x90, 6);
	*(PBYTE)0x540046 = 0x85;
	*(PBYTE)0x540047 = 0xC9;
	*(PBYTE)0x540048 = 0x74;

	memset((PVOID)0x56E5AD, 0x90, 5);
	memset((PVOID)0x609CB4, 0x90, 5);

	memset((PVOID)0x60F2C4, 0x90, 25);

	memset((PVOID)0x6B18F1, 0x90, 5);
	memset((PVOID)0x6B9298, 0x90, 5);
	memset((PVOID)0x6F1793, 0x90, 5);
	memset((PVOID)0x6F86B6, 0x90, 5);

	*(BYTE*)0x0047C477 = 0xEB;

	*(BYTE*)0x0053A984 = 0xEB;
	*(BYTE*)0x0053A985 = 0x77;

	memset((PVOID)0x0060F289, 0x90, 8);
	memset((PVOID)0x0060F29D, 0x90, 19);

	memset((iGtaVersion == GTASA_VERSION_USA10) ? (PVOID)0x748063 : (PVOID)0x7480B3, 0x90, 5);

	*(BYTE*)0x58DB5F = 0xBD;
	*(BYTE*)0x58DB60 = 0x00;
	*(BYTE*)0x58DB61 = 0x00;
	*(BYTE*)0x58DB62 = 0x00;
	*(BYTE*)0x58DB63 = 0x00;
	*(BYTE*)0x58DB64 = 0x90;
	*(BYTE*)0x58DB65 = 0x90;
	*(BYTE*)0x58DB66 = 0x90;
	*(BYTE*)0x58DB67 = 0x90;

	memset((PVOID)0x00575B0E, 0x90, 5);

	*(PBYTE)0x71162C = 80;

	memset((PVOID)0x63ADC8, 0x90, 6);

	memset((PVOID)0x6A8500, 0xC3, 116);

	memset((PVOID)0x570535, 0x90, 15);
	memset((PVOID)0x5E7847, 0x90, 17);
	memset((PVOID)0x570546, 0x90, 175);

	memset((PVOID)0x64DB49, 0x90, 9);
	memset((PVOID)0x64BC9F, 0x90, 9);
	memset((PVOID)0x64B872, 0x90, 9);

	*(BYTE*)0x5E7D62 = 0x5E;
	*(BYTE*)0x5E7D63 = 0x5D;
	*(BYTE*)0x5E7D64 = 0xC2;
	*(BYTE*)0x5E7D65 = 0x1C;
	*(BYTE*)0x5E7D66 = 0x00;

	*(DWORD*)0x6348F6 = 0xFFFFFFFF;
	*(DWORD*)0x634DE2 = 0xFFFFFFFF;

	*(float*)0x7361B2 = -20000.0f;
	*(float*)0x7361CB = 20000.0f;
	*(float*)0x7361E0 = -20000.0f;
	*(float*)0x7361F5 = 20000.0f;

	*(BYTE*)0x712025 = 1;

	memset((PVOID)0x53BF28, 0x90, 5);

	memset((PVOID)0x4C3A5B, 0x90, 10);

	memset((void*)0x442E47, 0x90, 5);
	memset((void*)0x443200, 0x90, 6);

	*(unsigned char*)0x53E94C = 0;

	*(unsigned char*)0xBAB318 = 0;

	*(unsigned long*)0x006D170B = 0xE9;
	*(unsigned long*)0x006D170C = 0x006D17D5 - 0x006D170B - 5;

	memset((void*)0x4422F9, 0x90, 5);

	*(BYTE*)0x58FC2C = 0xEB;
	memset((PVOID)0x58FC2E, 0x90, 30);

	*(bool*)0x96C009 = true;

	memset((PVOID)0x44AC75, 0x90, 5);
	*(BYTE*)0x44AC75 = 0xB0;
	*(BYTE*)0x44AC76 = 0x01;

	*(BYTE*)0x447B80 = 0xC3;

	*(BYTE*)0x8D477C = 0;
	*(BYTE*)0x8D477D = 0;

	*(BYTE*)0x52A535 = 0;

	*(DWORD*)0x44B1C1 = (DWORD)&g_pVehicleColor;
	*(DWORD*)0x4C8390 = (DWORD)&g_pVehicleColor;
	*(DWORD*)0x4C8399 = (DWORD)&g_pVehicleColor->g;
	*(DWORD*)0x4C83A3 = (DWORD)&g_pVehicleColor->b;
	*(DWORD*)0x5817CC = (DWORD)&g_pVehicleColor;
	*(DWORD*)0x582176 = (DWORD)&g_pVehicleColor;
	*(DWORD*)0x6A6FFA = (DWORD)&g_pVehicleColor;

	memset((void*)0x4217F4, 0x90, 21);
	memset((void*)0x4218D8, 0x90, 17);
	memset((void*)0x5F80C0, 0x90, 10);
	memset((void*)0x5FBA47, 0x90, 10);

	memset((void*)0x52457D, 0x90, 10);

	RelocateScanListHack();
	RelocatePedsListHack();

	memset((PVOID)0x6884C4, 0x90, 6);
	memset((PVOID)0x688200, 0x90, 6);

	InstallSCMEventsProcessor();
}

static struct
{
	DWORD func_tbl;
	BYTE  data[64];
} PedModelsMemory[600];

void RelocatePedsListHack()
{
	BYTE* aPedsListMemory = (BYTE*)&PedModelsMemory[0];

	for (int x = 0; x < 600; ++x)
	{
		PedModelsMemory[x].func_tbl = 0x85BDC0;
		memset(PedModelsMemory[x].data, 0, sizeof(PedModelsMemory[x].data));
	}

	*(DWORD*)0x4C67AD = (DWORD)aPedsListMemory;
}

static unsigned char ScanListMemory[8 * 20000];

static DWORD dwPatchAddrScanReloc1USA[14] = {
0x5DC7AA,0x41A85D,0x41A864,0x408259,0x711B32,0x699CF8,
0x4092EC,0x40914E,0x408702,0x564220,0x564172,0x563845,
0x84E9C2,0x85652D };

static DWORD dwPatchAddrScanReloc1EU[14] = {
0x5DC7AA,0x41A85D,0x41A864,0x408261,0x711B32,0x699CF8,
0x4092EC,0x40914E,0x408702,0x564220,0x564172,0x563845,
0x84EA02,0x85656D };

static DWORD dwPatchAddrScanReloc2USA[56] = {
0x0040D68C,0x005664D7,0x00566586,0x00408706,0x0056B3B1,0x0056AD91,0x0056A85F,0x005675FA,
0x0056CD84,0x0056CC79,0x0056CB51,0x0056CA4A,0x0056C664,0x0056C569,0x0056C445,0x0056C341,
0x0056BD46,0x0056BC53,0x0056BE56,0x0056A940,0x00567735,0x00546738,0x0054BB23,0x006E31AA,
0x0040DC29,0x00534A09,0x00534D6B,0x00564B59,0x00564DA9,0x0067FF5D,0x00568CB9,0x00568EFB,
0x00569F57,0x00569537,0x00569127,0x0056B4B5,0x0056B594,0x0056B2C3,0x0056AF74,0x0056AE95,
0x0056BF4F,0x0056ACA3,0x0056A766,0x0056A685,0x0070B9BA,0x0056479D,0x0070ACB2,0x006063C7,
0x00699CFE,0x0041A861,0x0040E061,0x0040DF5E,0x0040DDCE,0x0040DB0E,0x0040D98C,0x01566855 };

static DWORD dwPatchAddrScanReloc2EU[56] = {
0x0040D68C,0x005664D7,0x00566586,0x00408706,0x0056B3B1,0x0056AD91,0x0056A85F,0x005675FA,
0x0056CD84,0x0056CC79,0x0056CB51,0x0056CA4A,0x0056C664,0x0056C569,0x0056C445,0x0056C341,
0x0056BD46,0x0056BC53,0x0056BE56,0x0056A940,0x00567735,0x00546738,0x0054BB23,0x006E31AA,
0x0040DC29,0x00534A09,0x00534D6B,0x00564B59,0x00564DA9,0x0067FF5D,0x00568CB9,0x00568EFB,
0x00569F57,0x00569537,0x00569127,0x0056B4B5,0x0056B594,0x0056B2C3,0x0056AF74,0x0056AE95,
0x0056BF4F,0x0056ACA3,0x0056A766,0x0056A685,0x0070B9BA,0x0056479D,0x0070ACB2,0x006063C7,
0x00699CFE,0x0041A861,0x0040E061,0x0040DF5E,0x0040DDCE,0x0040DB0E,0x0040D98C,0x01566845 };

static DWORD dwPatchAddrScanReloc3[11] = {
0x004091C5,0x00409367,0x0040D9C5,0x0040DB47,0x0040DC61,0x0040DE07,0x0040DF97,
0x0040E09A,0x00534A98,0x00534DFA,0x0071CDB0 };

static DWORD dwPatchAddrScanRelocEnd[4] = { 0x005634A6, 0x005638DF, 0x0056420F, 0x00564283 };

void RelocateScanListHack()
{
	DWORD oldProt = 0;
	memset(ScanListMemory, 0, sizeof(ScanListMemory));
	unsigned char* aScanListMemory = ScanListMemory;

	const DWORD* list1 = (iGtaVersion == GTASA_VERSION_USA10) ? dwPatchAddrScanReloc1USA : dwPatchAddrScanReloc1EU;
	const DWORD* list2 = (iGtaVersion == GTASA_VERSION_USA10) ? dwPatchAddrScanReloc2USA : dwPatchAddrScanReloc2EU;

	for (int x = 0; x < 14; ++x)
	{
		VirtualProtect((PVOID)list1[x], 4, PAGE_EXECUTE_READWRITE, &oldProt);
		*(PDWORD)list1[x] = (DWORD)aScanListMemory;
	}

	for (int x = 0; x < 56; ++x)
	{
		VirtualProtect((PVOID)list2[x], 8, PAGE_EXECUTE_READWRITE, &oldProt);
		*(PDWORD)(list2[x] + 3) = (DWORD)aScanListMemory;
	}

	for (int x = 0; x < 11; ++x)
	{
		VirtualProtect((PVOID)dwPatchAddrScanReloc3[x], 8, PAGE_EXECUTE_READWRITE, &oldProt);
		*(PDWORD)(dwPatchAddrScanReloc3[x] + 3) = (DWORD)(aScanListMemory + 4);
	}

	for (int x = 0; x < 4; ++x)
	{
		VirtualProtect((PVOID)dwPatchAddrScanRelocEnd[x], 4, PAGE_EXECUTE_READWRITE, &oldProt);
		*(PDWORD)dwPatchAddrScanRelocEnd[x] = (DWORD)(aScanListMemory + sizeof(ScanListMemory));
	}

	VirtualProtect((PVOID)0x40936A, 4, PAGE_EXECUTE_READWRITE, &oldProt);
	*(PDWORD)0x40936A = (DWORD)(aScanListMemory + 4);

	memset((BYTE*)0xB7D0B8, 0, 8 * 14400);
}
